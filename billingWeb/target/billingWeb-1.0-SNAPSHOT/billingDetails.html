<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pahana Edu - Billing Details</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2B2D42;
            --primary-dark: #1D1E2C;
            --secondary: #8D99AE;
            --accent: #EF233C;
            --background: #F8FAFC;
            --card-bg: #FFFFFF;
            --text-primary: #2B2D42;
            --text-secondary: #6B7280;
        }

        body {
            background: var(--background);
            font-family: 'Inter', sans-serif;
            color: var(--text-primary);
            line-height: 1.6;
        }

        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            background: var(--primary);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .navbar-brand {
            font-weight: 600;
            font-size: 1.5rem;
            color: white !important;
        }

        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            background: var(--card-bg);
        }

        .card-header {
            background: var(--primary);
            color: white;
            border-radius: 12px 12px 0 0;
            padding: 1.25rem 1.5rem;
            border-bottom: none;
        }

        .btn-primary {
            background: var(--primary);
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .btn-outline-primary {
            border-color: var(--primary);
            color: var(--primary);
            border-radius: 8px;
            font-weight: 500;
        }

        .btn-outline-primary:hover {
            background: var(--primary);
            color: white;
        }

        .table {
            border-radius: 8px;
            overflow: hidden;
        }

        .table thead th {
            background: var(--primary);
            color: white;
            font-weight: 500;
            text-transform: none;
            padding: 1rem;
            border: none;
        }

        .table tbody tr {
            border-bottom: 1px solid #E5E7EB;
            transition: background 0.2s ease;
        }

        .table tbody tr:hover {
            background: #F9FAFB;
        }

        .form-control, .form-select {
            border-radius: 8px;
            border: 1px solid #D1D5DB;
            padding: 0.75rem;
            font-size: 0.875rem;
            height: 46px;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(43,45,66,0.1);
        }

        .form-label {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .modal-content {
            border-radius: 12px;
            border: none;
        }

        .modal-header {
            background: var(--primary);
            color: white;
            border-radius: 12px 12px 0 0;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .spinner-overlay {
            background: rgba(255, 255, 255, 0.95);
            z-index: 10000;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .action-buttons .btn {
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
        }

        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            background: var(--primary);
            color: white;
            padding: 10px;
        }

        .search-buttons .btn {
            height: 46px;
            padding: 0 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Print styles */
        @media print {
            body * {
                visibility: hidden;
            }
            #printSection, #printSection * {
                visibility: visible;
            }
            #printSection {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 20px;
            }
            .no-print {
                display: none !important;
            }
        }

        #printSection {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg no-print">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-receipt me-2"></i>Billing Details
            </a>
        </div>
    </nav>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="spinner-overlay d-none no-print">
        <div class="text-center">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="mt-3">
                <h5>Loading...</h5>
            </div>
        </div>
    </div>

    <div class="container-fluid py-5 no-print" style="margin-top: 20px; margin-bottom: 60px;">
        <!-- Filters Section -->
        <div class="card mb-4 fade-in">
            <div class="card-header">
                <h5 class="mb-0">Filter Bills</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Customer</label>
                        <select id="filterCustomer" class="form-select">
                            <option value="">All Customers</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Bill Number</label>
                        <input type="text" id="filterBillNo" class="form-control" placeholder="Enter bill number">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Customer Account No</label>
                        <input type="text" id="filterAccountNo" class="form-control" placeholder="Enter account number">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Date Range</label>
                        <div class="input-group">
                            <input type="date" id="filterDateStart" class="form-control">
                            <span class="input-group-text">to</span>
                            <input type="date" id="filterDateEnd" class="form-control">
                        </div>
                    </div>
                    <div class="col-12 text-end">
                        <button id="applyFiltersBtn" class="btn btn-primary">
                            <i class="fas fa-filter me-1"></i>Apply Filters
                        </button>
                        <button id="clearFiltersBtn" class="btn btn-outline-primary">
                            <i class="fas fa-eraser me-1"></i>Clear Filters
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bills Table -->
        <div class="card fade-in">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table id="billsTable" class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Bill No</th>
                                <th>Bill ID</th>
                                <th>Customer</th>
                                <th>Account No</th>
                                <th>Total Amount</th>
                                <th>Created At</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="billsTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Bill Details Modal -->
    <div class="modal fade no-print" id="billDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Bill Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Bill No</label>
                            <input type="text" id="detailBillNo" class="form-control" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Bill ID</label>
                            <input type="text" id="detailBillId" class="form-control" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Customer</label>
                            <input type="text" id="detailCustomer" class="form-control" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Account No</label>
                            <input type="text" id="detailAccountNo" class="form-control" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Total Amount</label>
                            <input type="text" id="detailTotalAmount" class="form-control" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Created At</label>
                            <input type="text" id="detailCreatedAt" class="form-control" readonly>
                        </div>
                        <div class="col-12">
                            <h5>Items</h5>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Item</th>
                                            <th>Unit Price</th>
                                            <th>Quantity</th>
                                            <th>Subtotal</th>
                                        </tr>
                                    </thead>
                                    <tbody id="detailItemsTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-info" onclick="openSendBillModal(document.getElementById('detailBillId').value, document.getElementById('detailBillNo').value, null, document.getElementById('detailCustomer').value)">
                        <i class="fas fa-paper-plane me-1"></i>Send Bill
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Send Bill Modal -->
    <div class="modal fade no-print" id="sendBillModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Send Bill via Email</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Bill No: <span id="sendBillNo"></span></label>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Customer: <span id="sendCustomerName"></span></label>
                    </div>
                    <div class="mb-3">
                        <label for="customerEmail" class="form-label">Customer Email</label>
                        <input type="email" id="customerEmail" class="form-control" placeholder="Enter customer email" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancel
                    </button>
                    <button type="button" id="sendBillBtn" class="btn btn-primary">
                        <i class="fas fa-paper-plane me-1"></i>Send Bill
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Print Section -->
    <div id="printSection">
        <h2>Pahana Edu - Bill</h2>
        <hr>
        <div class="row">
            <div class="col-md-6">
                <p><strong>Bill No:</strong> <span id="printBillNo"></span></p>
                <p><strong>Bill ID:</strong> <span id="printBillId"></span></p>
                <p><strong>Customer:</strong> <span id="printCustomer"></span></p>
            </div>
            <div class="col-md-6">
                <p><strong>Account No:</strong> <span id="printAccountNo"></span></p>
                <p><strong>Total Amount:</strong> <span id="printTotalAmount"></span></p>
                <p><strong>Created At:</strong> <span id="printCreatedAt"></span></p>
            </div>
        </div>
        <h4>Items</h4>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Item</th>
                    <th>Unit Price</th>
                    <th>Quantity</th>
                    <th>Subtotal</th>
                </tr>
            </thead>
            <tbody id="printItemsTableBody"></tbody>
        </table>
        <p class="text-end"><strong>Total: <span id="printTotal"></span></strong></p>
        <p class="text-center">Thank you for your business!</p>
    </div>

    <!-- Footer -->
    <footer class="footer no-print">
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-6">
                    <p class="mb-0">Â© 2025 Pahana Edu. All rights reserved.</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <a href="#" class="text-white text-decoration-none me-3">Privacy Policy</a>
                    <a href="#" class="text-white text-decoration-none">Terms of Service</a>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE_URL = 'http://localhost:8080/billingServices/resources';
        let allBills = [];
        let allCustomers = [];
        let billDetailsModal;
        let sendBillModal;

        document.addEventListener('DOMContentLoaded', function() {
            billDetailsModal = new bootstrap.Modal(document.getElementById('billDetailsModal'));
            sendBillModal = new bootstrap.Modal(document.getElementById('sendBillModal'));
            loadCustomers();
            loadBills();
            // Add event listeners for filters
            document.getElementById('applyFiltersBtn').addEventListener('click', filterBills);
            document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);
            // Add event listener for send bill button
            document.getElementById('sendBillBtn').addEventListener('click', sendBill);
        });

        // Load customers for filter dropdown
        async function loadCustomers() {
            try {
                showLoading();
                const response = await fetch(`${API_BASE_URL}/customers?status=approved`);
                allCustomers = await response.json();
                const filterCustomer = document.getElementById('filterCustomer');
                filterCustomer.innerHTML = '<option value="">All Customers</option>';
                allCustomers.forEach(customer => {
                    const option = document.createElement('option');
                    option.value = customer.id;
                    option.textContent = customer.name;
                    filterCustomer.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading customers:', error);
                showToast('Failed to load customers', 'danger');
            } finally {
                hideLoading();
            }
        }

        // Load all bills
        async function loadBills() {
            try {
                showLoading();
                const response = await fetch(`${API_BASE_URL}/bills/customer/0`);
                allBills = await response.json();
                console.log('Fetched bills:', allBills);
                displayBills(allBills);
            } catch (error) {
                console.error('Error loading bills:', error);
                showToast('Failed to load bills', 'danger');
            } finally {
                hideLoading();
            }
        }

        // Display bills in table
        async function displayBills(bills) {
            const tableBody = document.getElementById('billsTableBody');
            tableBody.innerHTML = '';

            if (bills.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-5">
                            <div class="text-muted">
                                <i class="fas fa-receipt fa-2x mb-3"></i>
                                <h5>No bills found</h5>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            let customerMap = {};
            try {
                const customerResponse = await fetch(`${API_BASE_URL}/customers`);
                if (customerResponse.ok) {
                    const customers = await customerResponse.json();
                    customers.forEach(customer => {
                        customerMap[customer.id] = { name: customer.name, accountNo: customer.accountNumber || '-' };
                    });
                } else {
                    console.error('Failed to fetch customers:', customerResponse.status);
                    showToast('Failed to load customer data', 'danger');
                }
            } catch (error) {
                console.error('Error fetching customers:', error);
                showToast('Failed to load customer data', 'danger');
            }

            bills.forEach(bill => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${bill.billNo}</td>
                    <td>${bill.id}</td>
                    <td>${customerMap[bill.customerId]?.name || 'Unknown'}</td>
                    <td>${customerMap[bill.customerId]?.accountNo || '-'}</td>
                    <td>Rs.${bill.totalAmount.toFixed(2)}</td>
                    <td>${formatDate(bill.createdAt)}</td>
                    <td>
                        <button class="btn btn-primary btn-sm me-1" onclick="viewBillDetails(${bill.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-success btn-sm me-1" onclick="printBillFromTable(${bill.id}, '${bill.billNo}', ${bill.customerId}, '${customerMap[bill.customerId]?.name || 'Unknown'}', '${customerMap[bill.customerId]?.accountNo || '-'}', ${bill.totalAmount}, '${bill.createdAt}')">
                            <i class="fas fa-print"></i>
                        </button>
                        <button class="btn btn-info btn-sm" onclick="openSendBillModal(${bill.id}, '${bill.billNo}', ${bill.customerId}, '${customerMap[bill.customerId]?.name || 'Unknown'}')">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Filter bills based on criteria
        function filterBills() {
            const customerId = document.getElementById('filterCustomer').value;
            const billNo = document.getElementById('filterBillNo').value.toLowerCase();
            const accountNo = document.getElementById('filterAccountNo').value.toLowerCase();
            const dateStart = document.getElementById('filterDateStart').value;
            const dateEnd = document.getElementById('filterDateEnd').value;

            const filteredBills = allBills.filter(bill => {
                const customer = allCustomers.find(c => c.id === bill.customerId) || { accountNumber: '' };
                const matchesCustomer = customerId ? bill.customerId.toString() === customerId : true;
                const matchesBillNo = billNo ? bill.billNo.toLowerCase().includes(billNo) : true;
                const matchesAccountNo = accountNo ? customer.accountNumber.toLowerCase().includes(accountNo) : true;
                const matchesDate = dateStart && dateEnd ? isDateInRange(bill.createdAt, dateStart, endDate) : true;
                return matchesCustomer && matchesBillNo && matchesAccountNo && matchesDate;
            });

            displayBills(filteredBills);
        }

        // Clear filters
        function clearFilters() {
            document.getElementById('filterCustomer').value = '';
            document.getElementById('filterBillNo').value = '';
            document.getElementById('filterAccountNo').value = '';
            document.getElementById('filterDateStart').value = '';
            document.getElementById('filterDateEnd').value = '';
            displayBills(allBills);
        }

        // Check if date is in range
        function isDateInRange(dateStr, startDate, endDate) {
            const billDate = new Date(dateStr);
            const start = new Date(startDate);
            const end = new Date(endDate);
            end.setHours(23, 59, 59, 999); // Include end date fully
            return billDate >= start && billDate <= end;
        }

        // View bill details
        async function viewBillDetails(billId) {
            console.log('Fetching bill details for billId:', billId);
            try {
                const elements = {
                    detailBillNo: document.getElementById('detailBillNo'),
                    detailBillId: document.getElementById('detailBillId'),
                    detailCustomer: document.getElementById('detailCustomer'),
                    detailAccountNo: document.getElementById('detailAccountNo'),
                    detailTotalAmount: document.getElementById('detailTotalAmount'),
                    detailCreatedAt: document.getElementById('detailCreatedAt'),
                    detailItemsTableBody: document.getElementById('detailItemsTableBody')
                };
                console.log('DOM elements:', elements);
                for (const [key, element] of Object.entries(elements)) {
                    if (!element) {
                        showToast(`DOM element ${key} not found`, 'danger');
                        return;
                    }
                }

                const response = await fetch(`${API_BASE_URL}/bills/${billId}`);
                const bill = await response.json();
                console.log('Bill response:', bill);
                if (response.ok) {
                    let customer = { name: 'Unknown', accountNumber: '-' };
                    try {
                        const customerResponse = await fetch(`${API_BASE_URL}/customers/${bill.customerId}`);
                        console.log('Customer fetch status:', customerResponse.status);
                        if (customerResponse.ok) {
                            customer = await customerResponse.json();
                            console.log('Customer data:', customer);
                        } else {
                            showToast('Failed to fetch customer details', 'danger');
                        }
                    } catch (error) {
                        console.error('Customer fetch error:', error);
                        showToast('Failed to fetch customer details', 'danger');
                    }

                    let itemMap = {};
                    try {
                        const itemResponse = await fetch(`${API_BASE_URL}/items`);
                        console.log('Items fetch status:', itemResponse.status);
                        if (itemResponse.ok) {
                            const items = await itemResponse.json();
                            console.log('Items data:', items);
                            items.forEach(item => {
                                itemMap[item.id] = item.name;
                            });
                        } else {
                            showToast('Failed to fetch items', 'danger');
                        }
                    } catch (error) {
                        console.error('Items fetch error:', error);
                        showToast('Failed to fetch items', 'danger');
                    }

                    elements.detailBillNo.value = bill.billNo || '';
                    elements.detailBillId.value = bill.id || '';
                    elements.detailCustomer.value = customer.name || 'Unknown';
                    elements.detailAccountNo.value = customer.accountNumber || '-';
                    elements.detailTotalAmount.value = bill.totalAmount ? `Rs.${bill.totalAmount.toFixed(2)}` : '';
                    elements.detailCreatedAt.value = formatDate(bill.createdAt);

                    elements.detailItemsTableBody.innerHTML = '';
                    (bill.billItems || []).forEach(item => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${itemMap[item.itemId] || 'Unknown'}</td>
                            <td>Rs.${item.unitPrice ? item.unitPrice.toFixed(2) : '0.00'}</td>
                            <td>${item.quantity || 0}</td>
                            <td>Rs.${item.subtotal ? item.subtotal.toFixed(2) : '0.00'}</td>
                        `;
                        elements.detailItemsTableBody.appendChild(row);
                    });

                    console.log('Showing billDetailsModal');
                    billDetailsModal.show();
                } else {
                    showToast(bill.error || 'Failed to fetch bill details', 'danger');
                }
            } catch (error) {
                console.error('Error fetching bill details:', error);
                showToast('Failed to fetch bill details', 'danger');
            }
        }

        // Open send bill modal
        async function openSendBillModal(billId, billNo, customerId, customerName) {
            document.getElementById('sendBillNo').textContent = billNo;
            document.getElementById('sendCustomerName').textContent = customerName;
            document.getElementById('customerEmail').value = '';

            // Fetch customer email if customerId is provided
            if (customerId) {
                try {
                    showLoading();
                    const response = await fetch(`${API_BASE_URL}/customers/${customerId}`);
                    const customer = await response.json();
                    if (response.ok) {
                        document.getElementById('customerEmail').value = customer.email || '';
                    } else {
                        showToast('Failed to load customer email', 'danger');
                    }
                } catch (error) {
                    console.error('Error fetching customer details:', error);
                    showToast('Failed to load customer email', 'danger');
                } finally {
                    hideLoading();
                }
            }

            sendBillModal.show();
            window.currentBillId = billId; // Store billId for sending
        }

        // Send bill via email
        async function sendBill() {
            const billId = window.currentBillId;
            const email = document.getElementById('customerEmail').value;

            if (!email) {
                showToast('Please enter a valid email address', 'danger');
                return;
            }

            try {
                showLoading();
                const response = await fetch(`${API_BASE_URL}/bills/${billId}/send`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                const result = await response.json();
                if (response.ok) {
                    showToast(result.message || 'Bill sent successfully');
                    sendBillModal.hide();
                } else {
                    showToast(result.error || 'Failed to send bill', 'danger');
                }
            } catch (error) {
                console.error('Error sending bill:', error);
                showToast('Failed to send bill', 'danger');
            } finally {
                hideLoading();
            }
        }

        // Print bill from table
        async function printBillFromTable(billId, billNo, customerId, customerName, accountNo, totalAmount, createdAt) {
            try {
                const response = await fetch(`${API_BASE_URL}/bills/${billId}`);
                const bill = await response.json();
                if (response.ok) {
                    const billData = {
                        id: billId,
                        billNo: billNo,
                        customerId: customerId,
                        customerName: customerName,
                        accountNo: accountNo,
                        totalAmount: totalAmount,
                        createdAt: createdAt,
                        billItems: bill.billItems
                    };
                    const itemResponse = await fetch(`${API_BASE_URL}/items`);
                    const items = await itemResponse.json();
                    const itemMap = {};
                    items.forEach(item => {
                        itemMap[item.id] = item.name;
                    });
                    billData.billItems.forEach(item => {
                        item.name = itemMap[item.itemId] || 'Unknown';
                    });
                    printBill(billData);
                } else {
                    showToast(bill.error || 'Failed to fetch bill details for printing', 'danger');
                }
            } catch (error) {
                console.error('Error fetching bill details for printing:', error);
                showToast('Failed to fetch bill details for printing', 'danger');
            }
        }

        // Print bill
        function printBill(billData) {
            const printSection = document.getElementById('printSection');
            document.getElementById('printBillNo').textContent = billData.billNo;
            document.getElementById('printBillId').textContent = billData.id;
            document.getElementById('printCustomer').textContent = billData.customerName || 'Unknown';
            document.getElementById('printAccountNo').textContent = billData.accountNo || '-';
            document.getElementById('printTotalAmount').textContent = `Rs.${billData.totalAmount.toFixed(2)}`;
            document.getElementById('printCreatedAt').textContent = formatDate(billData.createdAt);
            document.getElementById('printTotal').textContent = `Rs.${billData.totalAmount.toFixed(2)}`;

            const printItemsTableBody = document.getElementById('printItemsTableBody');
            printItemsTableBody.innerHTML = '';
            billData.billItems.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.name || 'Unknown'}</td>
                    <td>Rs.${item.unitPrice.toFixed(2)}</td>
                    <td>${item.quantity}</td>
                    <td>Rs.${item.subtotal.toFixed(2)}</td>
                `;
                printItemsTableBody.appendChild(row);
            });

            printSection.style.display = 'block';
            window.print();
            printSection.style.display = 'none';
        }

        // Show loading spinner
        function showLoading() {
            document.getElementById('loadingSpinner').classList.remove('d-none');
        }

        // Hide loading spinner
        function hideLoading() {
            document.getElementById('loadingSpinner').classList.add('d-none');
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type} border-0`;
            toast.setAttribute('role', 'alert');
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            
            const container = document.getElementById('toastContainer') || createToastContainer();
            container.appendChild(toast);
            
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            
            toast.addEventListener('hidden.bs.toast', () => toast.remove());
        }

        function createToastContainer() {
            const container = document.createElement('div');
            container.id = 'toastContainer';
            container.className = 'toast-container position-fixed top-0 end-0 p-3';
            container.style.zIndex = '9999';
            document.body.appendChild(container);
            return container;
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return '-';
            return new Date(dateString).toLocaleDateString();
        }
    </script>
</body>
</html>